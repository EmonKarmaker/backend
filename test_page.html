<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quran Recitation Test</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 32px;
            margin-bottom: 10px;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 16px;
        }
        
        .content {
            padding: 30px;
        }
        
        .status {
            padding: 15px 20px;
            margin-bottom: 25px;
            border-radius: 10px;
            font-weight: bold;
            text-align: center;
            font-size: 16px;
        }
        
        .status.connected {
            background: #d4edda;
            color: #155724;
            border: 2px solid #28a745;
        }
        
        .status.disconnected {
            background: #f8d7da;
            color: #721c24;
            border: 2px solid #dc3545;
        }
        
        .status.waiting {
            background: #fff3cd;
            color: #856404;
            border: 2px solid #ffc107;
        }
        
        .status.recording {
            background: #ffebee;
            color: #c62828;
            border: 2px solid #f44336;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .selection-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 25px;
            border: 2px solid #dee2e6;
        }
        
        .selection-section h3 {
            margin-bottom: 20px;
            color: #495057;
            font-size: 18px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #495057;
        }
        
        .form-group select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #ced4da;
            border-radius: 8px;
            font-size: 16px;
            background: white;
            cursor: pointer;
            transition: border-color 0.3s;
        }
        
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .expected-text {
            background: #e3f2fd;
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #2196f3;
            margin-bottom: 25px;
            display: none;
        }
        
        .expected-text.show {
            display: block;
        }
        
        .expected-text h4 {
            margin-bottom: 10px;
            color: #1976d2;
        }
        
        .expected-text .arabic {
            font-size: 28px;
            font-family: "Traditional Arabic", "Arabic Typesetting", serif;
            text-align: center;
            padding: 15px;
            background: white;
            border-radius: 8px;
            margin: 10px 0;
            direction: rtl;
        }
        
        .expected-text .words {
            font-size: 14px;
            color: #555;
            text-align: center;
        }
        
        .controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }
        
        button {
            padding: 15px 30px;
            font-size: 16px;
            font-weight: 600;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .btn-primary {
            background: #007bff;
            color: white;
        }
        
        .btn-primary:hover:not(:disabled) {
            background: #0056b3;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-success:hover:not(:disabled) {
            background: #218838;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-danger:hover:not(:disabled) {
            background: #c82333;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .btn-warning {
            background: #ffc107;
            color: #212529;
        }
        
        .btn-warning:hover:not(:disabled) {
            background: #e0a800;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .results-section {
            margin-top: 30px;
        }
        
        .results-section h3 {
            margin-bottom: 20px;
            color: #495057;
        }
        
        .result-card {
            background: white;
            border: 3px solid #ddd;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            transition: transform 0.3s;
        }
        
        .result-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .result-card.green {
            background: #d4edda;
            border-color: #28a745;
        }
        
        .result-card.yellow {
            background: #fff3cd;
            border-color: #ffc107;
        }
        
        .result-card.orange {
            background: #ffe5cc;
            border-color: #fd7e14;
        }
        
        .result-card.red {
            background: #f8d7da;
            border-color: #dc3545;
        }
        
        .result-card .word {
            font-size: 32px;
            font-family: "Traditional Arabic", "Arabic Typesetting", serif;
            text-align: center;
            margin-bottom: 15px;
            direction: rtl;
        }
        
        .result-card .details {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .result-card .detail-item {
            padding: 8px;
            background: rgba(255,255,255,0.5);
            border-radius: 6px;
        }
        
        .result-card .detail-item strong {
            display: block;
            font-size: 12px;
            color: #666;
            margin-bottom: 3px;
        }
        
        .result-card .message {
            text-align: center;
            font-size: 18px;
            font-weight: bold;
            padding: 10px;
            background: rgba(255,255,255,0.7);
            border-radius: 6px;
        }
        
        .log {
            background: #f8f9fa;
            padding: 15px;
            border: 2px solid #dee2e6;
            border-radius: 10px;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            margin-top: 20px;
        }
        
        .log-entry {
            margin: 5px 0;
            padding: 5px;
            border-left: 3px solid transparent;
            padding-left: 10px;
        }
        
        .log-send {
            color: #007bff;
            border-left-color: #007bff;
        }
        
        .log-receive {
            color: #28a745;
            border-left-color: #28a745;
        }
        
        .log-error {
            color: #dc3545;
            border-left-color: #dc3545;
        }
        
        .log-info {
            color: #6c757d;
            border-left-color: #6c757d;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 25px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }
        
        .stat-card .value {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .stat-card .label {
            font-size: 14px;
            opacity: 0.9;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üïå Quran Recitation Evaluator</h1>
            <p>Test your Quran recitation with real-time AI feedback</p>
        </div>
        
        <div class="content">
            <!-- Status Bar -->
            <div id="status" class="status disconnected">
                ‚ö™ Not Connected
            </div>
            
            <!-- Selection Section -->
            <div class="selection-section">
                <h3>üìñ Select Verse to Recite</h3>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="surahSelect">Surah (Chapter)</label>
                        <select id="surahSelect" onchange="updateSelection()">
                            <option value="1">1 - Al-Fatihah (ÿßŸÑŸÅÿßÿ™ÿ≠ÿ©)</option>
                            <option value="2">2 - Al-Baqarah (ÿßŸÑÿ®ŸÇÿ±ÿ©)</option>
                            <option value="3">3 - Ali 'Imran (ÿ¢ŸÑ ÿπŸÖÿ±ÿßŸÜ)</option>
                            <option value="112">112 - Al-Ikhlas (ÿßŸÑÿ•ÿÆŸÑÿßÿµ)</option>
                            <option value="113">113 - Al-Falaq (ÿßŸÑŸÅŸÑŸÇ)</option>
                            <option value="114">114 - An-Nas (ÿßŸÑŸÜÿßÿ≥)</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="ayahSelect">Ayah (Verse)</label>
                        <select id="ayahSelect" onchange="updateSelection()">
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                            <option value="5">5</option>
                            <option value="6">6</option>
                            <option value="7">7</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <!-- Expected Text Display -->
            <div id="expectedText" class="expected-text">
                <h4>Expected Text:</h4>
                <div class="arabic" id="arabicText">ÿ®Ÿêÿ≥€°ŸÖŸê Ÿ±ŸÑŸÑŸéŸëŸáŸê Ÿ±ŸÑÿ±ŸéŸëÿ≠€°ŸÖŸéŸÄŸ∞ŸÜŸê Ÿ±ŸÑÿ±ŸéŸëÿ≠ŸêŸäŸÖŸê</div>
                <div class="words" id="wordsList">Words will appear after connecting...</div>
            </div>
            
            <!-- Control Buttons -->
            <div class="controls">
                <button class="btn-primary" onclick="connect()" id="connectBtn">
                    üîå Connect to Server
                </button>
                <button class="btn-success" onclick="startRecording()" id="recordBtn" disabled>
                    üé§ Start Recording
                </button>
                <button class="btn-danger" onclick="stopRecording()" id="stopBtn" disabled>
                    ‚èπÔ∏è Stop Recording
                </button>
                <button class="btn-warning" onclick="clearResults()" id="clearBtn">
                    üóëÔ∏è Clear Results
                </button>
            </div>
            
            <!-- Statistics -->
            <div class="stats" id="stats" style="display: none;">
                <div class="stat-card">
                    <div class="value" id="totalWords">0</div>
                    <div class="label">Total Words</div>
                </div>
                <div class="stat-card">
                    <div class="value" id="correctWords">0</div>
                    <div class="label">Correct</div>
                </div>
                <div class="stat-card">
                    <div class="value" id="accuracy">0%</div>
                    <div class="label">Accuracy</div>
                </div>
            </div>
            
            <!-- Results Section -->
            <div class="results-section" id="resultsSection" style="display: none;">
                <h3>üìä Results:</h3>
                <div id="results"></div>
            </div>
            
            <!-- Log Section -->
            <details>
                <summary style="cursor: pointer; padding: 10px; background: #f8f9fa; border-radius: 8px; margin-bottom: 10px;">
                    <strong>üìã Connection Log</strong>
                </summary>
                <div id="log" class="log"></div>
            </details>
        </div>
    </div>

    <script>
        let websocket = null;
        let audioContext = null;
        let mediaStream = null;
        let processor = null;
        let source = null;
        let isRecording = false;
        let expectedWords = [];
        let results = [];
        
        const surahSelect = document.getElementById('surahSelect');
        const ayahSelect = document.getElementById('ayahSelect');

        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            const timestamp = new Date().toLocaleTimeString();
            entry.textContent = `[${timestamp}] ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function updateStatus(text, className) {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = text;
            statusDiv.className = `status ${className}`;
        }

        function updateSelection() {
            // Just update the display, actual connection happens when user clicks connect
            log(`Selected: Surah ${surahSelect.value}, Ayah ${ayahSelect.value}`, 'info');
        }

        function connect() {
            const surah = parseInt(surahSelect.value);
            const ayah = parseInt(ayahSelect.value);
            
            log(`Connecting to ws://localhost:8000/ws/live-recite...`, 'send');
            updateStatus('üîÑ Connecting...', 'waiting');

            websocket = new WebSocket('ws://localhost:8000/ws/live-recite');

            websocket.onopen = function() {
                log('‚úÖ WebSocket connected!', 'receive');
                updateStatus('‚úÖ Connected', 'connected');
                
                document.getElementById('connectBtn').disabled = true;
                document.getElementById('recordBtn').disabled = false;

                // Initialize session with selected Surah and Ayah
                const initMsg = {
                    type: 'init',
                    surah: surah,
                    ayah: ayah
                };
                
                log(`üì§ Initializing session: Surah ${surah}, Ayah ${ayah}`, 'send');
                websocket.send(JSON.stringify(initMsg));
            };

            websocket.onmessage = function(event) {
                const data = JSON.parse(event.data);
                log(`üì• Received: ${data.type}`, 'receive');

                if (data.type === 'session_started') {
                    expectedWords = data.expected_words || [];
                    log(`üìù Expected words (${expectedWords.length}): ${expectedWords.join(' ')}`, 'receive');
                    
                    // Display expected text
                    document.getElementById('expectedText').classList.add('show');
                    document.getElementById('wordsList').textContent = 
                        `${expectedWords.length} words: ${expectedWords.join(' ‚Ä¢ ')}`;
                    
                    // Update arabic text if available
                    if (expectedWords.length > 0) {
                        document.getElementById('arabicText').textContent = expectedWords.join(' ');
                    }
                }
                else if (data.type === 'word_result') {
                    displayResult(data);
                }
                else if (data.type === 'session_complete') {
                    log('üéâ Session complete!', 'receive');
                    updateStatus('‚úÖ Session Complete', 'connected');
                    if (isRecording) {
                        stopRecording();
                    }
                }
                else if (data.type === 'error') {
                    log(`‚ùå Error: ${data.message}`, 'error');
                    updateStatus('‚ùå Error', 'disconnected');
                }
            };

            websocket.onerror = function(error) {
                log('‚ùå WebSocket error', 'error');
                updateStatus('‚ùå Connection Error', 'disconnected');
            };

            websocket.onclose = function() {
                log('üîå WebSocket disconnected', 'error');
                updateStatus('‚ö™ Disconnected', 'disconnected');
                
                document.getElementById('connectBtn').disabled = false;
                document.getElementById('recordBtn').disabled = true;
                document.getElementById('stopBtn').disabled = true;
                
                if (isRecording) {
                    stopRecording();
                }
            };
        }

        async function startRecording() {
            if (isRecording) {
                log('‚ö†Ô∏è Already recording', 'info');
                return;
            }

            log('üé§ Requesting microphone access...', 'send');
            
            try {
                mediaStream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        sampleRate: 16000,
                        channelCount: 1,
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true
                    } 
                });

                log('‚úÖ Microphone access granted', 'receive');
                updateStatus('üé§ Recording...', 'recording');
                
                isRecording = true;
                document.getElementById('recordBtn').disabled = true;
                document.getElementById('stopBtn').disabled = false;
                document.getElementById('connectBtn').disabled = true;

                // Create audio context
                audioContext = new (window.AudioContext || window.webkitAudioContext)({ 
                    sampleRate: 16000 
                });
                
                source = audioContext.createMediaStreamSource(mediaStream);
                
                // Use ScriptProcessor for audio chunks
                const bufferSize = 2048;
                processor = audioContext.createScriptProcessor(bufferSize, 1, 1);

                let chunkCount = 0;
                let buffer = [];
                const targetChunkSize = 480; // 30ms at 16kHz

                processor.onaudioprocess = function(e) {
                    if (!websocket || websocket.readyState !== WebSocket.OPEN || !isRecording) {
                        return;
                    }

                    const inputData = e.inputBuffer.getChannelData(0);
                    
                    // Convert float32 to int16 PCM
                    for (let i = 0; i < inputData.length; i++) {
                        const sample = Math.max(-1, Math.min(1, inputData[i]));
                        buffer.push(Math.floor(sample * 32767));
                        
                        // When we have 480 samples (30ms), send as chunk
                        if (buffer.length >= targetChunkSize) {
                            const pcmData = new Int16Array(buffer.splice(0, targetChunkSize));
                            websocket.send(pcmData.buffer);
                            chunkCount++;
                            
                            if (chunkCount % 33 === 0) { // ~1 second
                                log(`Sent ${chunkCount} audio chunks (~${Math.floor(chunkCount/33)} seconds)`, 'send');
                            }
                        }
                    }
                };

                source.connect(processor);
                processor.connect(audioContext.destination);

                log('üéôÔ∏è Recording started - speak now!', 'receive');

            } catch (error) {
                log(`‚ùå Microphone error: ${error.message}`, 'error');
                alert('‚ùå Error: Could not access microphone!\n\nPlease:\n1. Allow microphone permission\n2. Use HTTPS or localhost\n3. Check if another app is using the mic');
                isRecording = false;
                document.getElementById('recordBtn').disabled = false;
                document.getElementById('stopBtn').disabled = true;
            }
        }

        function stopRecording() {
            if (!isRecording) {
                return;
            }

            log('‚èπÔ∏è Stopping recording...', 'send');
            
            isRecording = false;
            
            // Stop audio processing
            if (processor) {
                processor.disconnect();
                processor = null;
            }
            
            if (source) {
                source.disconnect();
                source = null;
            }
            
            if (mediaStream) {
                mediaStream.getTracks().forEach(track => track.stop());
                mediaStream = null;
            }
            
            if (audioContext) {
                audioContext.close();
                audioContext = null;
            }
            
            updateStatus('‚úÖ Connected', 'connected');
            document.getElementById('recordBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
            document.getElementById('connectBtn').disabled = false;
            
            log('‚úÖ Recording stopped', 'receive');
        }

        function displayResult(data) {
            document.getElementById('resultsSection').style.display = 'block';
            document.getElementById('stats').style.display = 'grid';
            
            results.push(data);
            
            const resultsDiv = document.getElementById('results');
            
            const card = document.createElement('div');
            card.className = `result-card ${data.color}`;
            
            const statusIcon = {
                'correct': '‚úÖ',
                'similar': '‚ö†Ô∏è',
                'wrong': '‚ùå'
            };
            
            card.innerHTML = `
                <div class="word">${data.expected}</div>
                <div class="details">
                    <div class="detail-item">
                        <strong>Expected</strong>
                        ${data.expected}
                    </div>
                    <div class="detail-item">
                        <strong>You Said</strong>
                        ${data.user_said}
                    </div>
                    <div class="detail-item">
                        <strong>Similarity</strong>
                        ${data.similarity}%
                    </div>
                    <div class="detail-item">
                        <strong>Status</strong>
                        ${statusIcon[data.status] || ''} ${data.status}
                    </div>
                </div>
                <div class="message">${data.message}</div>
            `;
            
            resultsDiv.insertBefore(card, resultsDiv.firstChild);
            
            // Update statistics
            updateStatistics();
            
            log(`‚úÖ Word evaluated: ${data.expected} - ${data.status} (${data.similarity}%)`, 'receive');
        }

        function updateStatistics() {
            const total = results.length;
            const correct = results.filter(r => r.status === 'correct').length;
            const avgAccuracy = total > 0 
                ? (results.reduce((sum, r) => sum + r.similarity, 0) / total).toFixed(1)
                : 0;
            
            document.getElementById('totalWords').textContent = total;
            document.getElementById('correctWords').textContent = correct;
            document.getElementById('accuracy').textContent = avgAccuracy + '%';
        }

        function clearResults() {
            results = [];
            document.getElementById('results').innerHTML = '';
            document.getElementById('resultsSection').style.display = 'none';
            document.getElementById('stats').style.display = 'none';
            log('üóëÔ∏è Results cleared', 'info');
        }

        // Initialize
        log('‚úÖ Page loaded - Ready to connect', 'info');
        updateSelection();
    </script>
</body>
</html>